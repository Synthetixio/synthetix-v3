version: 2.1

parameters:
  node-version:
    type: string
    default: "16.20.1"
    # TODO: update to Node 18 when we get fresh hardhat
    # default: "18.17.1"

commands:
  yarn-install:
    steps:
      - run: yarn install --immutable --immutable-cache

  install-foundry:
    steps:
      - restore_cache:
          keys:
            - foundry-{{ .Environment.FOUNDRY_CACHE_VERSION }}

      - run:
          name: "Install Foundry"
          working_directory: ~/
          environment:
            SHELL: /bin/bash
          command: |-
            export PATH="$PATH:$HOME/.foundry/bin"
            echo 'export PATH=$PATH:$HOME/.foundry/bin' >> $BASH_ENV

            if command -v anvil; then
              echo "Anvil already installed"
              anvil --version
            else
              curl -L https://foundry.paradigm.xyz | bash
              foundryup
            fi

      - save_cache:
          key: foundry-{{ .Environment.FOUNDRY_CACHE_VERSION }}
          paths:
            - "~/.foundry"

  install-ipfs:
    steps:
      - restore_cache:
          keys:
            - ipfs-{{ .Environment.IPFS_CACHE_VERSION }}

      - run:
          name: "Install IPFS"
          working_directory: ~/
          command: |
            export PATH="$PATH:$HOME/go-ipfs"
            echo 'export PATH=$PATH:$HOME/go-ipfs' >> $BASH_ENV

            if command -v ipfs; then
              echo "IPFS already installed"
              ipfs version
              ipfs id
            else
              LATEST_VERSION=$(curl -sSL https://dist.ipfs.tech/go-ipfs/versions | tail -n 1)
              LATEST_VERSION_NUMBER=${LATEST_VERSION#*v}
              DOWNLOAD_URL="https://dist.ipfs.tech/go-ipfs/${LATEST_VERSION}/go-ipfs_${LATEST_VERSION}_linux-amd64.tar.gz"
              echo "DOWNLOAD_URL=$DOWNLOAD_URL"
              curl -sSL -o ipfs.tar.gz $DOWNLOAD_URL
              tar -xzf ipfs.tar.gz
              rm -rf ~/.ipfs
              ipfs init
            fi

      - save_cache:
          key: ipfs-{{ .Environment.IPFS_CACHE_VERSION }}
          paths:
            - "~/go-ipfs"
            - "~/.ipfs"

  run-ipfs-daemon:
    steps:
      - run:
          command: ipfs daemon
          background: true

  wait-for-ipfs:
    steps:
      - run:
          name: "Wait for IPFS daemon to start"
          command: wget --retry-connrefused --waitretry=20 --read-timeout=20 --timeout=15 -t 10 --post-data '' "http://localhost:5001/api/v0/version"

  version-contracts:
    steps:
      # Find the last update of any contract
      - run: |
          git log -1 -- \
            utils/core-modules/contracts \
            utils/core-contracts/contracts \
            protocol/synthetix/contracts \
            protocol/governance/contracts \
            protocol/oracle-manager/contracts \
            markets/spot-market/contracts \
            markets/perps-market/contracts \
            markets/legacy-market/contracts \
            > /tmp/version--contracts.txt
      - run: cat /tmp/version--contracts.txt

  version-testable-contracts:
    steps:
      # Currently we only have testable contracts generated for @synthetixio/main
      # Add more folders to version calc (space separated)
      - run: git log -1 -- protocol/synthetix/contracts > /tmp/version--testable-contracts.txt
      - run: cat /tmp/version--testable-contracts.txt

jobs:
  build-testable:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - install-foundry
      - install-ipfs
      - run-ipfs-daemon
      - yarn-install
      - wait-for-ipfs
      - run: yarn workspaces foreach --topological-dev --verbose run build:ts

      - version-testable-contracts

      - restore_cache:
          keys:
            - testable-contracts-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--testable-contracts.txt" }}

      - run:
          name: "@synthetixio/main: generate-testable"
          command: |-
            if test -d "protocol/synthetix/contracts/generated/test" && [ $(ls protocol/synthetix/contracts/generated/test | wc -l) -gt 1  ]; then
              echo "SKIP, no changes detected"
            else
              yarn workspace "@synthetixio/main" run generate-testable
            fi
      - save_cache:
          key: testable-contracts-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--testable-contracts.txt" }}
          paths:
            - "protocol/synthetix/contracts/generated"
            # Add more folders here if we generate more

      - version-contracts

      - restore_cache:
          keys:
            - cannon-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--contracts.txt" }}

      - run: yarn workspaces foreach --topological-dev --verbose run build-testable

      - run: yarn workspaces foreach --verbose run check:storage

      - save_cache:
          key: cannon-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--contracts.txt" }}
          paths:
            - "~/.local/share/cannon"

      # As we generated all the testables, we also got typechain-types generated for all packages, cache them
      - save_cache:
          key: typechain-types-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--contracts.txt" }}
          paths:
            - "utils/core-modules/typechain-types"
            - "protocol/synthetix/typechain-types"
            - "protocol/governance/typechain-types"
            - "protocol/oracle-manager/typechain-types"
            - "markets/legacy-market/typechain-types"
            - "markets/perps-market/typechain-types"
            - "markets/spot-market/typechain-types"

  test-contracts:
    parameters:
      workspace:
        type: string
      parallelism:
        type: integer
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    parallelism: << parameters.parallelism >>
    steps:
      - checkout
      - install-foundry
      - install-ipfs
      - run-ipfs-daemon
      - yarn-install
      - wait-for-ipfs

      - version-contracts
      - restore_cache:
          keys:
            - typechain-types-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--contracts.txt" }}
      - restore_cache:
          keys:
            - cannon-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--contracts.txt" }}

      - version-testable-contracts
      - restore_cache:
          keys:
            - testable-contracts-{{ .Environment.CACHE_VERSION }}-{{ checksum "/tmp/version--testable-contracts.txt" }}

      - run: yarn workspaces foreach --topological-dev --recursive --verbose --from "<< parameters.workspace >>" run build:ts

      - run:
          name: "Run tests"
          environment:
            REPORT_GAS: true
          command: |
            export PATH=$PATH:$PWD/node_modules/.bin
            _dir=$(yarn workspace "<< parameters.workspace >>" exec pwd)
            echo "Workspace: $_dir"
            cd $_dir
            _tests=$(circleci tests glob 'test/**/*.test.ts' | circleci tests split --split-by=timings)
            echo "Tests:"
            for _test in $_tests; do
              echo $_test
            done
            mocha --timeout 30000 --require hardhat/register --reporter mocha-junit-reporter --reporter-options mochaFile=/tmp/junit/report.xml --exit $_tests

      - store_test_results:
          path: "/tmp/junit"

  test-core-utils:
    parameters:
      workspace:
        type: string
      parallelism:
        type: integer
    parallelism: << parameters.parallelism >>
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - yarn-install

      - run: yarn workspaces foreach --topological-dev --recursive --verbose --from "<< parameters.workspace >>" run build:ts

      - run:
          name: "Run tests"
          command: |
            export PATH=$PATH:$PWD/node_modules/.bin
            _dir=$(yarn workspace "<< parameters.workspace >>" exec pwd)
            echo "Workspace: $_dir"
            cd $_dir
            _tests=$(circleci tests glob 'test/**/*.test.ts' | circleci tests split --split-by=timings)
            echo "Tests:"
            for _test in $_tests; do
              echo $_test
            done
            mocha --timeout 10000 --require ts-node/register --reporter mocha-junit-reporter --reporter-options mochaFile=/tmp/junit/report.xml --exit $_tests

      - store_test_results:
          path: "/tmp/junit"

  test-core-modules:
    parameters:
      workspace:
        type: string
      parallelism:
        type: integer
    parallelism: << parameters.parallelism >>
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - install-foundry
      - install-ipfs
      - run-ipfs-daemon
      - yarn-install
      - wait-for-ipfs

      - run: yarn workspaces foreach --topological-dev --recursive --verbose --from "<< parameters.workspace >>" run build:ts

      - run:
          name: "Run tests"
          environment:
            REPORT_GAS: true
          command: |
            export PATH=$PATH:$PWD/node_modules/.bin
            _dir=$(yarn workspace "<< parameters.workspace >>" exec pwd)
            echo "Workspace: $_dir"
            cd $_dir
            _tests=$(circleci tests glob 'test/**/*.test.ts' | circleci tests split --split-by=timings)
            echo "Tests:"
            for _test in $_tests; do
              echo $_test
            done
            mocha --timeout 10000 --require hardhat/register --reporter mocha-junit-reporter --reporter-options mochaFile=/tmp/junit/report.xml --exit $_tests

      - store_test_results:
          path: "/tmp/junit"

  test-core-contracts:
    parameters:
      workspace:
        type: string
      parallelism:
        type: integer
    parallelism: << parameters.parallelism >>
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - yarn-install

      - run: yarn workspaces foreach --topological-dev --recursive --verbose --from "<< parameters.workspace >>" run build:ts

      - run: yarn workspace "<< parameters.workspace >>" run compile-contracts

      - run:
          name: "Run tests"
          environment:
            REPORT_GAS: true
          command: |
            export PATH=$PATH:$PWD/node_modules/.bin
            _dir=$(yarn workspace "<< parameters.workspace >>" exec pwd)
            echo "Workspace: $_dir"
            cd $_dir
            _tests=$(circleci tests glob 'test/**/*.test.ts' | circleci tests split --split-by=timings)
            echo "Tests:"
            for _test in $_tests; do
              echo $_test
            done
            mocha --timeout 20000 --require hardhat/register --reporter mocha-junit-reporter --reporter-options mochaFile=/tmp/junit/report.xml --exit $_tests

      - store_test_results:
          path: "/tmp/junit"

  size-contracts:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      #      - install-foundry
      #      - install-ipfs
      #      - run-ipfs-daemon
      - yarn-install
      #      - wait-for-ipfs

      - run: yarn workspaces foreach --topological-dev --verbose run build:ts
      - run: yarn workspaces foreach --verbose run size-contracts

  lint:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - yarn-install

      - run: yarn dedupe --check
      - run: yarn deps
      - run: yarn deps:mismatched
      - run: yarn deps:circular
      - run: yarn lint

  check-packages:
    docker:
      - image: cimg/node:<< pipeline.parameters.node-version >>
    steps:
      - checkout
      - run: yarn install --immutable --immutable-cache --check-cache

workflows:
  version: 2.1

  tests:
    jobs:
      - lint
      - size-contracts
      - check-packages

      - build-testable

      - test-contracts:
          name: "test-main"
          requires: [build-testable]
          workspace: "@synthetixio/main"
          parallelism: 2

      - test-contracts:
          name: "test-oracle-manager"
          requires: [build-testable]
          workspace: "@synthetixio/oracle-manager"
          parallelism: 1

      #- test-contracts: # TODO: enable when we have some tests
      #    name: "test-governance"
      #    requires: [build-testable]
      #    workspace: "@synthetixio/governance"

      - test-contracts:
          name: "test-spot-market"
          requires: [build-testable]
          workspace: "@synthetixio/spot-market"
          parallelism: 1

      - test-contracts:
          name: "test-perps-market"
          requires: [build-testable]
          workspace: "@synthetixio/perps-market"
          parallelism: 5

      #- test-contracts: # TODO: enable when tests are fixed
      #    name: "test-legacy-market"
      #    requires: [build-testable]
      #    workspace: "@synthetixio/legacy-market"

      - test-core-utils:
          workspace: "@synthetixio/core-utils"
          parallelism: 2

      - test-core-modules:
          workspace: "@synthetixio/core-modules"
          parallelism: 1

      - test-core-contracts:
          workspace: "@synthetixio/core-contracts"
          parallelism: 2
